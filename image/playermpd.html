<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Universal Live Player</title>

<style>
html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
}

#player-wrapper{
  position:relative;
  width:100%;
  height:100%;
}

/* Force fill */
video{
  width:100%!important;
  height:100%!important;
  object-fit:cover;
  background:#000;
}

/* Controls */
#controls{
  position:absolute;
  top:10px;
  right:10px;
  display:flex;
  gap:6px;
  padding:6px;
  background:rgba(0,0,0,.6);
  border-radius:6px;
  z-index:999;
  opacity:0;
  pointer-events:none;
  transition:.3s;
}

#controls.show{
  opacity:1;
  pointer-events:auto;
}

#controls button,select{
  background:#111;
  color:#fff;
  border:1px solid #444;
  padding:4px 6px;
  border-radius:4px;
}

/* Message */
#msg{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-size:14px;
  background:#000;
  z-index:998;
  display:none;
}
</style>
</head>

<body>

<div id="player-wrapper">
  <div id="controls">
    <select id="fit">
      <option value="cover">Fill</option>
      <option value="contain">Fit</option>
    </select>
    <button id="fs">⛶</button>
  </div>

  <div id="msg">Connecting to live stream…</div>

  <div id="jw"></div>
  <div id="clappr" style="display:none"></div>
  <video id="native" controls playsinline style="display:none"></video>
</div>

<!-- Players -->
<script src="https://cdn.jwplayer.com/libraries/MAaRkUjT.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>

<script>
const params = new URLSearchParams(location.search);
const stream = params.get("url");

const wrapper = document.getElementById("player-wrapper");
const controls = document.getElementById("controls");
const msg = document.getElementById("msg");

let retry = 0;

/* Show controls on touch */
wrapper.addEventListener("click",showControls);
wrapper.addEventListener("touchstart",showControls);
function showControls(){
  controls.classList.add("show");
  clearTimeout(window.ht);
  window.ht = setTimeout(()=>controls.classList.remove("show"),3000);
}

/* Fullscreen */
fs.onclick=()=>{
  !document.fullscreenElement?wrapper.requestFullscreen():document.exitFullscreen();
};

/* Fit / Fill */
fit.onchange=e=>{
  document.querySelectorAll("video").forEach(v=>v.style.objectFit=e.target.value);
};

/* PLAY LOGIC */
function playJW(){
  msg.style.display="flex";
  jwplayer.defaults={hlshtml:true};

  jwplayer("jw").setup({
    file:stream,
    width:"100%",
    height:"100%",
    autostart:true,
    stretching:"fill",
    mute:false
  });

  jwplayer().on("play",()=>msg.style.display="none");

  jwplayer().on("error",()=>{
    jwplayer().remove();
    playClappr();
  });
}

function playClappr(){
  document.getElementById("jw").style.display="none";
  document.getElementById("clappr").style.display="block";

  const p = new Clappr.Player({
    source:stream,
    parentId:"#clappr",
    autoPlay:true,
    width:"100%",
    height:"100%"
  });

  setTimeout(()=>{
    if(!p.isPlaying()){
      p.destroy();
      playNative();
    }
  },5000);
}

function playNative(){
  const v = document.getElementById("native");
  v.style.display="block";
  v.src=stream;
  v.play().then(()=>msg.style.display="none")
  .catch(()=>retryStream());
}

function retryStream(){
  retry++;
  if(retry>5){
    msg.innerText="Live stream is offline";
    return;
  }
  msg.innerText="Reconnecting…";
  setTimeout(playJW,3000);
}

/* START */
if(!stream){
  msg.style.display="flex";
  msg.innerText="No stream URL";
}else{
  playJW();
}
</script>

</body>
</html>
