<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Secure HLS/DASH Player</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
  }

  .player-wrapper {
    position: fixed;
    inset: 0;
    background: black;
  }

  #video-player, #clappr-player {
    width: 100%;
    height: 100%;
  }

  /* Control buttons */
  .controls {
    position: fixed;
    bottom: 15px;
    right: 15px;
    z-index: 9999;
    display: flex;
    gap: 10px;
  }

  .controls button {
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: 1px solid #fff;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    border-radius: 4px;
  }
</style>
</head>

<body>

<div class="player-wrapper">
  <div id="video-player"></div>
  <div id="clappr-player" style="display:none;"></div>
</div>

<div class="controls">
  <button onclick="toggleFullscreen()">⛶ Fullscreen</button>
  <button onclick="toggleFit()">↔ Fit</button>
</div>

<!-- JW Player -->
<script src="https://cdn.jwplayer.com/libraries/MAaRkUjT.js"></script>

<!-- Clappr -->
<script src="https://cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clappr-drm@latest/dist/clappr-drm.min.js"></script>

<script>
let fitMode = "cover";
let jwInstance = null;
let clapprInstance = null;

function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return {
    url: params.get("mpd"),
    keyId: params.get("keyId"),
    key: params.get("key")
  };
}

function isHLS(url) {
  return url && url.endsWith(".m3u8");
}

function isDASH(url) {
  return url && url.endsWith(".mpd");
}

function applyFit(mode) {
  const videos = document.querySelectorAll("video");
  videos.forEach(v => {
    v.style.objectFit = mode;
    v.style.width = "100%";
    v.style.height = "100%";
  });
}

function toggleFit() {
  fitMode = fitMode === "cover" ? "contain" : "cover";
  applyFit(fitMode);
}

function toggleFullscreen() {
  const el = document.documentElement;
  if (!document.fullscreenElement) {
    el.requestFullscreen().catch(()=>{});
  } else {
    document.exitFullscreen();
  }
}

function playStream(url, keyId, key) {
  if (!url) {
    document.body.innerHTML =
      "<p style='color:white;text-align:center;'>No stream URL provided</p>";
    return;
  }

  // JW Player
  if (typeof jwplayer !== "undefined") {
    document.getElementById("video-player").style.display = "block";
    jwInstance = jwplayer("video-player").setup({
      file: url,
      width: "100%",
      height: "100%",
      autostart: true,
      stretching: "fill"
    });

    if (key && keyId) {
      jwInstance.setup({
        drm: { clearkey: { keyId, key } }
      });
    }

    jwInstance.on("ready", () => applyFit(fitMode));
    return;
  }

  // Clappr fallback
  document.getElementById("clappr-player").style.display = "block";
  const config = {
    source: url,
    parentId: "#clappr-player",
    autoPlay: true,
    width: "100%",
    height: "100%"
  };

  if (key && keyId) {
    config.playback = {
      drm: { clearkey: { keys: [{ keyId, key }] } }
    };
    config.plugins = [ClapprDRM];
  }

  clapprInstance = new Clappr.Player(config);
  setTimeout(() => applyFit(fitMode), 1000);
}

window.addEventListener("DOMContentLoaded", () => {
  const { url, keyId, key } = getQueryParams();
  playStream(url, keyId, key);
});
</script>

</body>
</html>
